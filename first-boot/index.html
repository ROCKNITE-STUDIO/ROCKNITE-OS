<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROCKNITE-OS First Boot</title>
<style>
body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at top left, #0a0a0a, #000);
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.wizard-container {
    background: #0a0a0a;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 0 50px #007bff55;
    width: 900px;
    max-width: 95vw;
    display: flex;
    flex-direction: column;
    align-items: center;
}
h1 {
    text-align: center;
    font-size: 2.5em;
    margin-bottom: 25px;
    background: linear-gradient(90deg, #007bff, #ff0033);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.wizard-body {
    display: flex;
    gap: 20px;
    height: 420px;
    width: 100%;
}
.wizard-left, .wizard-right {
    flex: 1;
    border-radius: 15px;
    padding: 20px;
    background: #111;
    overflow-y: auto;
}
.wizard-left {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
    line-height: 1.5em;
    text-align: center;
}
.page {
    display: none;
}
.page.active {
    display: block;
}
label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    text-transform: uppercase;
    color: #00bfff;
}
button {
    padding: 12px 25px;
    font-size: 1em;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    background: linear-gradient(90deg, #007bff, #ff0033);
    color: #fff;
    transition: 0.3s;
}
button:hover {
    filter: brightness(1.2);
}
.btn-container {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    width: 100%;
}
/* Liste custom */
.selection-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    overflow-y: auto;
}
.selection-item {
    flex: 1 1 45%;
    padding: 10px;
    text-align: center;
    background: #111;
    border: 1px solid #333;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.3s;
}
.selection-item:hover {
    background: #007bff33;
}
.selection-item.selected {
    border-color: #007bff;
    box-shadow: 0 0 10px #007bff;
}
input[type="password"], input[type="email"], input[type="text"] {
    width: 95%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #111;
    color: #fff;
    font-size: 1em;
    margin-bottom: 10px;
}
#wifi-status {
    font-size: 0.9em;
    color: #00ff99;
    margin-bottom: 10px;
}
.optional {
    font-size: 0.85em;
    color: #888;
    margin-bottom: 10px;
}
#wifi-pass {
    margin-bottom: 10px;
}
/* WI-FI LISTE */
#wifi-list {
    max-height: 260px;
    overflow-y: auto;
}
hr {
    border: 0;
    border-top: 1px solid #333;
    margin: 15px 0;
}
</style>
</head>
<body>

<div class="wizard-container">
    <h1>ROCKNITE-OS First Boot</h1>
    <div class="wizard-body">
        <div class="wizard-left" id="wizard-left">
            <p>Bienvenue dans <b>ROCKNITE-OS</b> !</p>
        </div>

        <div class="wizard-right">

            <!-- PAGE LANGUE -->
            <div class="page active" id="page-language">
                <label>Choisir la langue :</label>
                <div class="selection-list" id="language-list">
                    <div class="selection-item" data-value="fr">Fran√ßais</div>
                    <div class="selection-item" data-value="en">English</div>
                    <div class="selection-item" data-value="es">Espa√±ol</div>
                    <div class="selection-item" data-value="de">Deutsch</div>
                    <div class="selection-item" data-value="jp">Êó•Êú¨Ë™û</div>
                    <div class="selection-item" data-value="cn">‰∏≠Êñá</div>
                </div>
            </div>

            <!-- PAGE WIFI -->
            <div class="page" id="page-wifi">
                <label>R√©seau Wi-Fi :</label>
                <div class="selection-list" id="wifi-list">Chargement...</div>
                <input type="password" id="wifi-pass" placeholder="Mot de passe (si n√©cessaire)">
                <div id="wifi-status"></div>
            </div>

            <!-- PAGE COMPTE -->
            <div class="page" id="page-account">
                <label>Compte ROCKNITE (optionnel)</label>

                <!-- Connexion -->
                <input type="email" id="rocknite-email" placeholder="Email">
                <input type="password" id="rocknite-pass" placeholder="Mot de passe">
                <button type="button" onclick="loginRocknite()">Se connecter</button>

                <hr>

                <!-- Inscription -->
                <input type="email" id="rocknite-email-reg" placeholder="Email">
                <input type="text" id="rocknite-name-reg" placeholder="Nom">
                <input type="password" id="rocknite-pass-reg" placeholder="Mot de passe">
                <input type="password" id="rocknite-pass2-reg" placeholder="Confirmer le mot de passe">
                <button type="button" onclick="registerRocknite()">S'inscrire</button>

                <div id="rocknite-status" style="margin-top:10px;"></div>
            </div>

            <!-- PAGE OS PASSWORD -->
            <div class="page" id="page-os-pass">
                <label>Mot de passe syst√®me (optionnel)</label>
                <input type="password" id="os-pass" placeholder="Mot de passe ROCKNITE-OS">
                <div class="optional">Laissez vide si vous n'en voulez pas.</div>
            </div>

        </div>
    </div>

    <div class="btn-container">
        <button onclick="prevPage()">‚óÄ Pr√©c√©dent</button>
        <button id="next-btn" onclick="nextPage()">Suivant ‚ñ∂</button>
    </div>
</div>

<script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
<script>
let currentPage = 0;
const pages = document.querySelectorAll('.page');
const BACKEND_URL = "http://127.0.0.1:5000";
let selectedWifi = null;

const pb = new PocketBase("https://rocknite-studio.alwaysdata.net");

// PAGE SWITCH
function showPage(index) {
    pages.forEach(p => p.classList.remove('active'));
    pages[index].classList.add('active');
    currentPage = index;
    if (pages[currentPage].id === 'page-wifi') loadWifi();
    updateNextButton();
}

function nextPage() {
    if (pages[currentPage].id === 'page-wifi') {
        if (!selectedWifi) { skipWifi(); return; }
        const pass = document.getElementById('wifi-pass').value;
        connectWifi(selectedWifi, pass);
        return;
    }
    if (currentPage < pages.length - 1) showPage(currentPage + 1);
    else finishWizard();
}

function prevPage() { if (currentPage > 0) showPage(currentPage - 1); }

// LANGUE
document.querySelectorAll('#language-list .selection-item').forEach(item=>{
    item.addEventListener('click', ()=>{
        document.querySelectorAll('#language-list .selection-item').forEach(el=>el.classList.remove('selected'));
        item.classList.add('selected');
    });
});

// WIFI
async function loadWifi() {
    const container = document.getElementById('wifi-list');
    container.innerHTML = "üîç Recherche des r√©seaux...";
    selectedWifi = null;
    updateNextButton();
    try {
        const res = await fetch(`${BACKEND_URL}/scan-wifi`);
        const data = await res.json();
        container.innerHTML = '';
        data.networks.forEach(ssid=>{
            const div = document.createElement('div');
            div.className='selection-item';
            div.textContent=ssid;
            div.onclick=()=>{ selectWifi(div, ssid); };
            container.appendChild(div);
        });
        if (!data.networks.length) container.textContent="Aucun r√©seau trouv√©.";
    } catch(e) { container.textContent="‚ö†Ô∏è Erreur de d√©tection Wi-Fi."; }
}

function selectWifi(div, ssid) {
    if(selectedWifi===ssid){ div.classList.remove('selected'); selectedWifi=null; }
    else{ document.querySelectorAll('#wifi-list .selection-item').forEach(el=>el.classList.remove('selected'));
          div.classList.add('selected'); selectedWifi=ssid; }
    updateNextButton();
}

function updateNextButton() {
    const nextBtn=document.getElementById('next-btn');
    if(pages[currentPage].id==='page-wifi'){
        nextBtn.textContent=selectedWifi?"Se connecter":"Passer";
    } else nextBtn.textContent="Suivant ‚ñ∂";
}

async function connectWifi(ssid, password) {
    const status=document.getElementById('wifi-status');
    status.textContent="Connexion...";
    try {
        const res = await fetch(`${BACKEND_URL}/connect-wifi`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ssid,password})
        });
        const data = await res.json();
        if(data.status==='connected'){
            status.textContent="‚úÖ Connect√© !";
            setTimeout(()=>showPage(currentPage+1),800);
        } else status.textContent="‚ùå √âchec : "+(data.error||"Erreur inconnue");
    } catch(e){ status.textContent="‚ö†Ô∏è Erreur de connexion."; }
}

function skipWifi(){ showPage(currentPage+1); }

// ROCKNITE LOGIN/REGISTER
async function loginRocknite() {
    const email=document.getElementById('rocknite-email').value;
    const password=document.getElementById('rocknite-pass').value;
    const status=document.getElementById('rocknite-status');
    try {
        await pb.collection('users').authWithPassword(email,password);
        const user=pb.authStore.model;
        status.textContent=`‚úÖ Connect√© : ${user.email}`;
    } catch(err){
        status.textContent=`‚ùå Erreur : ${err.message}`;
    }
}

async function registerRocknite() {
    const email=document.getElementById('rocknite-email-reg').value;
    const name=document.getElementById('rocknite-name-reg').value;
    const password=document.getElementById('rocknite-pass-reg').value;
    const password2=document.getElementById('rocknite-pass2-reg').value;
    const status=document.getElementById('rocknite-status');
    if(password!==password2){ status.textContent="‚ùå Les mots de passe ne correspondent pas !"; return; }
    try {
        await pb.collection('users').create({email,name,password,passwordConfirm:password2});
        status.textContent="‚úÖ Compte cr√©√© ! Connectez-vous ci-dessus.";
    } catch(err){ status.textContent=`‚ùå Erreur : ${err.message}`; }
}

// FIN DU WIZARD
function finishWizard(){
    const langSel=document.querySelector('#language-list .selected');
    const setupData={
        language:langSel?langSel.dataset.value:'fr',
        wifi:selectedWifi,
        rockniteAccount:{
            email:pb.authStore.isValid?pb.authStore.model.email:'',
            password:''
        },
        osPassword:document.getElementById('os-pass').value
    };
    localStorage.setItem('rockniteOS_setup',JSON.stringify(setupData));
    localStorage.setItem('firstBootDone','true');
    window.location.href='/home';
}
</script>

</body>
</html>
